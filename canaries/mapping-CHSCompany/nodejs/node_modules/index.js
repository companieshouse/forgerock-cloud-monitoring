var synthetics = require('Synthetics');
const log = require('SyntheticsLogger');

const rcsMonitoring = async function () {

    let accessToken;
    const { FIDC_URL, USER, PASSWORD, ADMIN_CLIENT, ADMIN_CLIENT_SECRET, MONITORED_COMPONENT } = process.env

    function percentage(partialValue, totalValue) {
        return (100 * partialValue) / totalValue;
     } 

    const validateAccessToken = async function (res) {
        return new Promise((resolve, reject) => {
            if (res.statusCode < 200 || res.statusCode > 299) {
                throw res.statusCode + ' ' + res.statusMessage;
            }

            let responseBody = '';
            res.on('data', (d) => {
                responseBody += d;
            });

            res.on('end', () => {
                // Add validation on 'responseBody' here if required.
                accessToken = JSON.parse(responseBody).access_token;
                resolve();
            });
        });
    };

    const validateMappingsHealth = async function (res) {
        return new Promise((resolve, reject) => {
            if (res.statusCode < 200 || res.statusCode > 299) {
                throw res.statusCode + ' ' + res.statusMessage;
            }

            let responseBody = '';
            res.on('data', (d) => {
                responseBody += d;
            });

            res.on('end', () => {
                const mapping = JSON.parse(responseBody).mappings.filter(mapping => mapping.recon)[0]
                const total = (mapping.recon.statusSummary.FAILURE + mapping.recon.statusSummary.SUCCESS)
                const percentFailed = percentage(mapping.recon.statusSummary.FAILURE, total)

                if (mapping && mapping.recon && mapping.recon.state === 'SUCCESS'){
                    log.info(`RECON_SUCCESS - ${mapping.name} - state: ${mapping.recon.state}, percent failed: ${percentFailed}, _id: ${mapping.recon._id}`)
                }

                if (mapping && mapping.recon && mapping.recon.state === 'FAILURE'){
                    log.info(`RECON_FAILURE - ${mapping.name} - state: ${mapping.recon.state}, percent failed: ${percentFailed}, _id: ${mapping.recon._id}`)
                }

                if (mapping && mapping.recon && mapping.recon.state === 'SUCCESS' && percentFailed < 30) {
                    log.info(`${mapping.name} - state: ${mapping.recon.state}, percent failed: ${percentFailed}, _id: ${mapping.recon._id}`)
                    resolve();
                } else {
                    log.info(`${mapping.name} - state: ${mapping.recon.state}, failures: ${mapping.recon.statusSummary.FAILURE}, percent failed: ${percentFailed}, _id: ${mapping.recon._id}`)
                    reject();
                }
            });
        });
    };


    // Set request option for Get Access Token
    const pw = `${PASSWORD}`
    const encodedPassword = encodeURIComponent(pw)
    const clientSecret = `${ADMIN_CLIENT_SECRET}`
    const encodedClientSecret = encodeURIComponent(clientSecret)

    let requestAccessToken = {
        hostname: FIDC_URL.replace('https://', ''),
        method: 'POST',
        path: '/am/oauth2/realms/root/realms/alpha/access_token?auth_chain=PasswordGrant',
        port: '443',
        protocol: 'https:',
        body: `grant_type=password&username=${USER}&password=${encodedPassword}&scope=fr:idm:*&client_id=${ADMIN_CLIENT}&client_secret=${encodedClientSecret}`,
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
    };
    requestAccessToken['headers']['User-Agent'] = [synthetics.getCanaryUserAgentString(), requestAccessToken['headers']['User-Agent']].join(' ');

    // Set step config option for Get Access Token
    let configAccessToken = {
        includeRequestHeaders: false,
        includeResponseHeaders: false,
        includeRequestBody: false,
        includeResponseBody: false,
        restrictedHeaders: [],
        continueOnHttpStepFailure: true
    };

    await synthetics.executeHttpStep('Get Access Token', requestAccessToken, validateAccessToken, configAccessToken);

      // Set request option for Verify Mappings Recon
      let requestMappingsHealth = {
        hostname: FIDC_URL.replace('https://', ''),
        method: 'GET',
        path: `/openidm/endpoint/mappingDetails?mapping=${MONITORED_COMPONENT}`,
        port: '443',
        protocol: 'https:',
        body: "",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${accessToken}` }
      };
      requestMappingsHealth['headers']['User-Agent'] = [synthetics.getCanaryUserAgentString(), requestMappingsHealth['headers']['User-Agent']].join(' ');

      // Set step config option for Verify Mappings Recon
      let configMappingsHealth = {
        includeRequestHeaders: false,
        includeResponseHeaders: false,
        includeRequestBody: false,
        includeResponseBody: false,
        restrictedHeaders: [],
        continueOnHttpStepFailure: true
      };

      return await synthetics.executeHttpStep(`Verify Mapping ${MONITORED_COMPONENT}`, requestMappingsHealth, validateMappingsHealth, configMappingsHealth);
};

exports.handler = async () => {
    return await rcsMonitoring();
};

